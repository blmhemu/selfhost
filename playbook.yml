---
# Playbook

- name: Ready nodes (Disable IPv6, APT maintainance, Install Tailscale)
  hosts: all
  roles:
    - role: ansible_disable_ipv6
      become: true
    - role: bootstrap
      vars:
        apt_force_ipv4: true
    - role: ansible_tailscale
      vars:
        tailscale_auth_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37623032323963306134626461323661396436366664323136333438353335653665363837316261
          3438623235383433623931373134363037616133633263650a336338653034346562383235393136
          34363761393461623532396634623336386131393564303263356663343864313466613335646238
          3663333965663061320a336135366261373636356537666262656436653563666537373438363665
          34323662613637303534343066623365396430326365613338653638633463313664
      when: ansible_tailscale0 is not defined # add a check to see if we got an ip address

- name: Install docker and podman
  hosts: nomad_clients
  roles:
    - ansible_docker
    - ansible_podman

- name: Install consul
  become: true
  hosts: consul_instances
  roles:
    - role: ansible_consul
      vars:
        consul_version: 1.9.5
        consul_iface: tailscale0
        consul_client_address: "{{ansible_tailscale0.ipv4.address}} 127.0.0.1"

- name: Install nomad
  become: true
  hosts: nomad_instances
  roles:
    - role: ansible_nomad
      vars:
        nomad_version: 1.1.0
        nomad_iface: tailscale0
        nomad_use_consul: true
        nomad_consul_address: "{{ansible_tailscale0.ipv4.address}}:8500"
        nomad_bootstrap_expect: 1 # Currently when nomad_use_consul is true, this is being set wrongly
        nomad_podman_enable: true
        nomad_podman_version: 0.2.0
        nomad_plugins:
          nomad-driver-podman:
            config:
              socket_path: unix://run/user/1000/podman/podman.sock
              volumes:
                enabled: true
              recover_stopped: true

- name: Configure dnsmasq to resolve consul subdomain
  hosts: consul_instances
  roles:
    - role: ansible_dnsmasq
      vars:
        dnsmasq_config: |
          no-resolv
          # For consul domain
          server=/consul/{{ansible_tailscale0.ipv4.address}}#8600
          # For remaining
          server=1.1.1.1
          server=8.8.8.8
          interface=tailscale0
          bind-dynamic
